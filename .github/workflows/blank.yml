
name: Build 
on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write  # å…è®¸åˆ›å»º release
jobs:
  build-macos-arm:
    runs-on: macos-14
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v3

      - name: Checkout private repo
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"
          git clone https://github.com/Lvbey/python-cicd-test.git python-cicd-test
          ls
          uname -m

      - name: Set up Miniforge (conda-forge for ARM)
        uses: conda-incubator/setup-miniconda@v3
        with:
          installer-url: https://github.com/conda-forge/miniforge/releases/download/23.11.0-0/Mambaforge-MacOSX-arm64.sh
          miniforge-variant: Mambaforge
          channels: conda-forge
          use-mamba: true
          auto-update-conda: true
          python-version: 3.9
          activate-environment: sxd

      - name: Restore Conda cache
        uses: actions/cache@v4
        with:
          path: |
            ~/conda_pkgs_dir
            ~/.conda
          key: conda-${{ runner.os }}-${{ hashFiles('python-cicd-test/mac-arm-environment.yml') }}

      - name: Set working directory to project folder
        working-directory: ./python-cicd-test
        run: |
          echo "ğŸ“ Now in $(pwd)"
          ls -la


      - name: Install dependencies via mac-arm-environment.yml
        run: |
          mamba env update -n sxd -f mac-arm-environment.yml
          conda info
          conda list

      - name: Run build/test script (example)
        run: |
          source ~/.bash_profile
          conda activate sxd
          echo "ğŸ”§ Running tests or build..."

          # è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„æ„å»ºå‘½ä»¤
          cp "api-ms-win-crt-util-l1-1-0.dll" "api-ms-win-crt-util-l1-1-0.dylib"
          cp "libcrypto-win-32-x64_86.dll" "libcrypto-win-32-x64_86.dylib"
          cp "libcrypto-win-64-x64_86.dll" "libcrypto-win-64-x64_86.dylib"

          pyinstaller -w --onedir \
            --add-data "sxd-logo.png:." \
            --add-data "api-ms-win-crt-util-l1-1-0.dylib:." \
            --add-data "libcrypto-win-32-x64_86.dylib:." \
            --add-data "libcrypto-win-64-x64_86.dylib:." \
            --icon="sxd-logo.png" \
            --name "sxd-v1.1.2-arm" \
            entrance.py --specpath . --noconfirm

          ls dist/sxd-v1.1.2-arm.app
          
          ditto -c -k --sequesterRsrc --keepParent dist/sxd-v1.1.2-arm.app dist/sxd-v1.1.2-arm-${{ github.run_id }}.zip

      - name: release artifact    
        uses: softprops/action-gh-release@v1
        with:
          files: dist/sxd-v1.1.2-arm-${{ github.run_id }}.zip
