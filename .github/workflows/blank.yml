
name: Build 
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v3

      - name: Checkout private repo
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"
          git clone https://github.com/Lvbey/python-cicd-test.git python-cicd-test
          ls
      - name: echo uname
        run: |
          uname -m

      - name: Set up Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          ls python-cicd-test
          cd python-cicd-test
          python -m pip install --upgrade pip
          python -m pip install -r requirements4action.txt
          python -m pip install nuitka pyinstaller

      - name: Install and pytest
        run: |
          python -m pip install pytest

          cp "api-ms-win-crt-util-l1-1-0.dll" "api-ms-win-crt-util-l1-1-0.dylib"
          cp "libcrypto-win-32-x64_86.dll" "libcrypto-win-32-x64_86.dylib"
          cp "libcrypto-win-64-x64_86.dll" "libcrypto-win-64-x64_86.dylib"
          pytest tests.py -s

      - name: Compile module with Nuitka
        run: |
          python -m nuitka --module win_x86 --include-package=win_x86

      - name: Package with PyInstaller
        run: |
          pyinstaller -w --onedir \
            --add-data "sxd-logo.png:." \
            --add-data "api-ms-win-crt-util-l1-1-0.dylib:." \
            --add-data "libcrypto-win-32-x64_86.dylib:." \
            --add-data "libcrypto-win-64-x64_86.dylib:." \
            --add-data "win_x86.cpython-39-darwin.so:." \
            --icon="sxd-logo.png" \
            --name "sxd-v1.1.2-x86_64" \
            entrance.py --specpath . --noconfirm
      - name: ls dist
        run: |
          ls dist/sxd-v1.1.2-x86_64.app
          
      - name: Compress .app properly
        run: |
          ditto -c -k --sequesterRsrc --keepParent dist/sxd-v1.1.2-x86_64.app dist/sxd-v1.1.2-x86_64-${{ github.run_id }}.zip

      - name: release artifact    
        uses: softprops/action-gh-release@v1
        with:
          files: dist/sxd-v1.1.2-x86_64-${{ github.run_id }}.zip 
