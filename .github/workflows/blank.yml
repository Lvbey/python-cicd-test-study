
name: Build 
on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write  # ÂÖÅËÆ∏ÂàõÂª∫ release
jobs:
  build-macos-arm:
    runs-on: macos-14

    env:
      SMTP_SERVER: smtp.163.com
      SMTP_PORT: 465
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      FILE_PATH: dist/sxd-v1.1.2-arm.zip

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v3

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Checkout private repo
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"
          git clone https://github.com/Lvbey/python-cicd-test.git python-cicd-test
          ls
          uname -m

      - name: Set up Miniforge (conda-forge for ARM)
        uses: conda-incubator/setup-miniconda@v3
        with:
          installer-url: https://github.com/conda-forge/miniforge/releases/download/23.11.0-0/Mambaforge-MacOSX-arm64.sh
          miniforge-variant: Mambaforge
          channels: conda-forge
          use-mamba: true
          auto-update-conda: true

      - name: Restore Conda cache
        uses: actions/cache@v4
        with:
          path: |
            ~/conda_pkgs_dir
            ~/.conda
          key: conda-${{ runner.os }}-${{ hashFiles('python-cicd-test/mac-arm-environment.yml') }}

      - name: Set working directory to project folder
        working-directory: ./python-cicd-test
        run: |
          echo "üìÅ Now in $(pwd)"
          ls -la


      - name: Install dependencies via mac-arm-environment.yml
        working-directory: ./python-cicd-test
        run: |
          mamba env create -n sxd -f mac-arm-environment.yml
          conda info
          conda list
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate sxd
          echo "üîß Running tests or build..."

          # ËøôÈáåÊõøÊç¢‰∏∫‰Ω†ÁöÑÊûÑÂª∫ÂëΩ‰ª§
          cp "api-ms-win-crt-util-l1-1-0.dll" "api-ms-win-crt-util-l1-1-0.dylib"
          cp "libcrypto-win-32-x64_86.dll" "libcrypto-win-32-x64_86.dylib"
          cp "libcrypto-win-64-x64_86.dll" "libcrypto-win-64-x64_86.dylib"
          conda install -y pyinstaller
          pyinstaller -w --onedir \
            --add-data "sxd-logo.png:." \
            --add-data "api-ms-win-crt-util-l1-1-0.dylib:." \
            --add-data "libcrypto-win-32-x64_86.dylib:." \
            --add-data "libcrypto-win-64-x64_86.dylib:." \
            --icon="sxd-logo.png" \
            --name "sxd-v1.1.2-arm" \
            entrance.py --specpath . --noconfirm

          ls dist/sxd-v1.1.2-arm.app
          
          ditto -c -k --sequesterRsrc --keepParent dist/sxd-v1.1.2-arm.app dist/sxd-v1.1.2-arm.zip

          #python send_file_by_email.py


          echo 'syncing to S3...'
          aws s3 cp dist/sxd-v1.1.2-arm.zip s3://my-standard-s3-bucket-name/sxd-v1.1.2-arm-${{ github.run_id }}.zip
          echo 'synced to S3!'

      - name: release artifact    
        uses: softprops/action-gh-release@v1
        with:
          files: ./python-cicd-test/dist/sxd-v1.1.2-arm.zip
